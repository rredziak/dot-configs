DEFAULT_MINIKUBE_PROFILE='1-31'

if [ -x /usr/bin/minikube ]; then
  source <(/usr/bin/minikube completion bash)

  /usr/bin/minikube profile "${DEFAULT_MINIKUBE_PROFILE}"

  if [ ! -x /usr/bin/kubectl ]; then
    KUBECTL="/usr/bin/minikube kubectl --"
    alias kubectl=${KUBECTL}
  fi
fi

if [ -x /usr/bin/kubectl -o -v KUBECTL ]; then
  source <(${KUBECTL:-/usr/bin/kubectl} completion bash)

  alias k=${KUBECTL:-/usr/bin/kubectl}
  complete -o default -F __start_kubectl k

  if [[ -x /usr/bin/kubectx ]]; then
    alias kctx=/usr/bin/kubectx
  else
    kctx() {
      if [[ $# -gt 0 ]]; then
        kubectl config use-context $@
      else
        kubectl config current-context 2>/dev/null
        local _cur_ctx_ec=$?
        local _all_ctx=$(kubectl config get-contexts -o name | tr '\n' ' ')
        if [[ $_cur_ctx_ec -ne 0 ]]; then
          echo "$_all_ctx"
        else
          local _cur_ctx=$(kubectl config current-context)
          echo "$_all_ctx" | grep -w $_cur_ctx
        fi
      fi
    }

    _kctx_get_contexts() {
      local cur prev words cword
      _init_completion || return

      local _contexts=$(kubectl config get-contexts -o name)
      COMPREPLY=($(compgen -W "$_contexts" "$cur"))

      return 0
    }

    complete -F _kctx_get_contexts kctx
  fi
fi
